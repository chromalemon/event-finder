{% extends "event_finder/base.html" %}
{% block title %}View Event{% endblock %}
{% block content %}
    <div class="event-details">
        <h1>{{ event.title }}</h1>
        <p class="detail"><strong>Start date:</strong> {{ event.start_time|date:"M d, Y H:i" }}</p>
        <p class="detail"><strong>End date:</strong> {{ event.end_time|date:"M d, Y H:i" }}</p>
        <p class="detail"><strong>Location:</strong> {{ event.location.formatted_address }}</p>
        <p class="detail"><strong>Hosted by: </strong><a href="{% url 'profile' event.host.pk %}">{{ event.host.username }}</p></a>
        <p class="detail"><strong>Description:</strong> {{ event.description }}</p>
        <p class="detail"><strong>Categories:</strong>
            {% for ec in event.event_categories.all %}
                {{ ec.cat.name }}{% if not forloop.last %}, {% endif %}
            {% empty %}
                No categories
            {% endfor %}</p>

        {# Attendees: host sees management UI, others see simple list #}
        <p class="detail"><strong>Attendees:</strong></p>
        {% if user == event.host %}
            {% if attendees_for_host %}
                <ul>
                    {% for att in attendees_for_host %}
                        <li style="margin-bottom:.5rem;">
                            <a href="{% url 'profile' att.user.pk %}">{{ att.user.username }}</a>
                            {% if att.created_at %} — Joined: {{ att.created_at|date:"M d, Y H:i" }}{% endif %}
                            <form method="POST" action="{% url 'events:change_attendee_status' event.pk %}" style="display:inline-block;margin-left:8px;">
                                {% csrf_token %}
                                <input type="hidden" name="attendee_id" value="{{ att.pk }}" />
                                <select name="status" aria-label="Status for {{ att.user.username }}">
                                    <option value="going" {% if att.status == "going" %}selected{% endif %}>Going</option>
                                    <option value="waitlist" {% if att.status == "waitlist" %}selected{% endif %}>Waitlist</option>
                                    <option value="not_going" {% if att.status == "not_going" %}selected{% endif %}>Not going</option>
                                </select>
                                <button type="submit" class="btn-small">Update</button>
                            </form>

                            <form method="POST" action="{% url 'events:change_attendee_status' event.pk %}" style="display:inline-block;margin-left:6px;">
                                {% csrf_token %}
                                <input type="hidden" name="attendee_id" value="{{ att.pk }}" />
                                <input type="hidden" name="action" value="remove" />
                                <button type="submit" class="btn-small btn-leave">Remove</button>
                            </form>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p>No attendees yet.</p>
            {% endif %}
        {% else %}
            {% if event.attendees.count > 0 %}
                <ul>
                    {% for attendee in event.attendees.all %}
                        <li><a href="{% url 'profile' attendee.user.id %}">{{ attendee.user.username }}</a></li>
                    {% endfor %}
                </ul>
            {% else %}
                <p>No attendees yet.</p>
            {% endif %}
        {% endif %}

        {# Waitlist shown only to host, limited to 5 and ordered by join date #}
        {% if user == event.host  %}
            <a href="{% url 'events:edit_event' event.id %}" class="btn-edit">Edit event</a>
            {% if waitlisted_users %}
                <p class="detail"><strong>Waitlist (up to 5 oldest):</strong></p>
                <ul>
                    {% for wa in waitlisted_users %}
                        <li>
                            <a href="{% url 'profile' wa.user.pk %}">{{ wa.user.username }}</a>
                            {% if wa.created_at %}
                                — Joined: {{ wa.created_at|date:"M d, Y H:i" }}
                            {% endif %}
                        </li>
                    {% endfor %}
                </ul>
            {% endif %}
        {% endif %}
    </div>

{% if user.is_authenticated %}
    {% if user_attendee %}
        {% if user_attendee.status != "not_going" %}
            <form method="POST" action="{% url 'events:leave_event' event.pk %}">
                {% csrf_token %}
                <button type="submit" class="btn-join btn-leave">Leave Event</button>
            </form>
            <!-- Open chat if user is attending -->
            <a class="btn-chat" href="{% url 'chat:room' event.pk %}">Open Event Chat</a>
        {% else %}
            <form method="POST" action="{% url 'events:join_event' event.pk %}">
                {% csrf_token %}
                <button type="submit" class="btn-join">Join Event</button>
            </form>
        {% endif %}
    {% else %}
        <form method="POST" action="{% url 'events:join_event' event.pk %}">
            {% csrf_token %}
            <button type="submit" class="btn-join">Join Event</button>
        </form>
    {% endif %}
{% else %}
    <a href="{% url 'login' %}?next={% url 'events:view_event' event.pk %}" class="btn-join">Log in to join</a>
    <br/>
    <a href="{% url 'login' %}?next={% url 'chat:room' event.pk %}" class="btn-chat">Log in to open chat</a>
{% endif %}

    <a href="{% url 'events:view_events' %}" class="btn-back">Back to events</a>


<style>
    h1 {
        font-size: 1.5em;
        margin: 20px;
    }
    .detail{
        font-size: 1.2em;
        margin: 10px 20px;
        width: 80%;
        padding: 10px;
    }
    .btn-join{
        display: inline-block;
        margin: 20px;
        padding: 10px 20px;
        background-color:rgb(20, 176, 41);
        color: white;
        text-decoration: none;
        border-radius: 5px;
    }
    .btn-leave{
        display: inline-block;
        margin: 20px;
        padding: 10px 20px;
        background-color:rgba(211, 34, 34, 1);
        color: white;
        text-decoration: none;
        border-radius: 5px;
    }
    .btn-back{
        display: inline-block;
        margin: 20px;
        padding: 10px 20px;
        background-color: #007bff;
        color: white;
        text-decoration: none;
        border-radius: 5px;
    }
    .btn-edit{
        display: inline-block;
        margin: 20px;
        padding: 10px 20px;
        background-color: #6e25ebff;
        color: white;
        text-decoration: none;
        border-radius: 5px;
    }
    .event-details {
        max-width: 800px;
        margin: auto;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 8px;
        background-color: #f9f9f9;
    }
    p{
    white-space: normal;
    word-wrap: break-word;
    overflow-wrap: break-word;
}
</style>
{% endblock %}
