<html>
  <head>
    <meta charset="utf-8" />
    <title>Create Event</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/styles.css' %}" />
    <!-- Leaflet CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <style>
      #map {
        height: 400px;
        width: 100%;
        margin-top: 20px;
      }
    </style>
  </head>
  <body>
    <h1>Create Event</h1>
    <form method="POST" enctype="multipart/form-data">
      {% csrf_token %} {{ form.title.label_tag }} {{ form.title }}<br />
      {{ form.description.label_tag }} {{ form.description }}<br />
      {{ form.datetime.label_tag }} {{ form.datetime }}<br />

      <label for="id_name">Location Name:</label>

      <input
        type="text"
        id="id_name"
        name="name"
        placeholder="Click or search"
        required
      />

      <button type="button" onclick="searchLocation()">Search</button
      ><br /><br />

      <input type="hidden" name="address" id="id_address" />
      <input type="hidden" name="city" id="id_city" />
      <input type="hidden" name="country" id="id_country" />
      <input type="hidden" name="postcode" id="id_postcode" />
      <input type="hidden" name="latitude" id="id_latitude" />
      <input type="hidden" name="longitude" id="id_longitude" />

      <button type="submit">Create Event</button>
    </form>

    <div id="map" style="height: 50%; width: 100%; margin-top: 20px"></div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
      // Trigger search on Enter key in name field
      document
        .getElementById("id_name")
        .addEventListener("keydown", function (e) {
          if (e.key === "Enter") {
            e.preventDefault(); // Prevent form submit
            searchLocation();
          }
        });

      // Optional: Trigger search when user stops typing for 800ms
      let searchTimeout;
      document.getElementById("id_name").addEventListener("input", function () {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          searchLocation();
        }, 800);
      });
      const map = L.map("map").setView([51.5074, -0.1278], 13); // Default to London

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "© OpenStreetMap contributors",
      }).addTo(map);

      let marker;

      map.on("click", function (e) {
        const { lat, lng } = e.latlng;
        if (marker) {
          marker.setLatLng([lat, lng]);
        } else {
          marker = L.marker([lat, lng]).addTo(map);
        }

        // Set lat/lon immediately
        document.getElementById("id_latitude").value = lat;
        document.getElementById("id_longitude").value = lng;

        // Show loading indicator in name field
        const nameInput = document.getElementById("id_name");
        nameInput.value = "Loading...";

        fetch(
          `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json`
        )
          .then((response) => response.json())
          .then((data) => {
            document.getElementById("id_address").value =
              data.display_name || "";
            document.getElementById("id_city").value =
              data.address?.city ||
              data.address?.town ||
              data.address?.village ||
              "";
            document.getElementById("id_country").value =
              data.address?.country || "";
            document.getElementById("id_postcode").value =
              data.address?.postcode || "";

            const guessName =
              data.address?.building ||
              data.address?.attraction ||
              data.address?.amenity ||
              data.address?.leisure ||
              data.address?.theatre ||
              data.address?.road ||
              data.name ||
              "";

            nameInput.value = guessName || "";
          })
          .catch(() => {
            nameInput.value = "";
            alert("Could not fetch location name. Try again later.");
          });
      });

      function searchLocation() {
        const query = document.getElementById("id_name").value;
        fetch(
          `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(
            query
          )}&format=json`
        )
          .then((response) => response.json())
          .then((data) => {
            if (data.length > 0) {
              const lat = parseFloat(data[0].lat);
              const lon = parseFloat(data[0].lon);
              map.setView([lat, lon], 15);

              if (marker) {
                marker.setLatLng([lat, lon]);
              } else {
                marker = L.marker([lat, lon]).addTo(map);
              }

              document.getElementById("id_latitude").value = lat;
              document.getElementById("id_longitude").value = lon;
              document.getElementById("id_address").value =
                data[0].display_name || "";

              // ✅ Also auto-fill `location` with display name
              document.getElementById("id_location").value =
                data[0].display_name || "";

              // Optional: also reverse geocode to get city, country, postcode
              fetch(
                `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`
              )
                .then((response) => response.json())
                .then((data) => {
                  const address = data.address || {};
                  document.getElementById("id_city").value =
                    address.city || address.town || address.village || "";
                  document.getElementById("id_country").value =
                    address.country || "";
                  document.getElementById("id_postcode").value =
                    address.postcode || "";
                });
            }
          });
      }
    </script>
  </body>
</html>
